---
title: 'ç®¡ç†åå°åŠç›‘æ§ç³»ç»Ÿ'
sidebar_position: 6
---


# ç®¡ç†åå°åŠç›‘æ§ç³»ç»Ÿ ğŸ–¥ï¸
### ğŸŸ¢ ç®¡ç†åå°å¼€æ”¾ç«¯å£

| TCP ç«¯å£  | è¯´æ˜                    | æ“ä½œ âš™ï¸                                      |
|:--------:|:-----------------------:|:--------------------------------------------:|
| TCP:11002| `http://ip:11002` è®¿é—®ç®¡ç†åå° | ç«¯å£æ”¾è¡Œæˆ– nginx åå‘ä»£ç†ï¼Œå¹¶å…³é—­é˜²ç«å¢™ |

## ğŸ“Œ è®¿é—®ç®¡ç†åå°

:::tip
åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ `http://ip:11002` æ¥è®¿é—®ç®¡ç†åå°ã€‚æ­¤ ip ä¸ºæœåŠ¡ç«¯ ip ï¼Œä¸”ç¡®ä¿æ‚¨çš„æµè§ˆå™¨èƒ½è®¿é—®ã€‚é»˜è®¤è´¦å·å’Œå¯†ç å‡ä¸ºadmin1
:::

![PC Web Interface](./assets/admin.jpg)

## ç›‘æ§&å‘Šè­¦ç³»ç»Ÿéƒ¨ç½²
æˆ‘ä»¬æä¾›ä¸¤ç§ç›‘æ§&å‘Šè­¦ç³»ç»Ÿçš„éƒ¨ç½²ï¼Œdocker-composeæ–¹å¼å’Œk8s helm chartæ–¹å¼ã€‚
æœ¬æ–‡æ¡£ä»‹ç»docker-composeæ–¹å¼éƒ¨ç½²openimçš„Prometheusç›‘æ§å’Œå‘Šè­¦åŠŸèƒ½çš„éƒ¨ç½²å’Œä½¿ç”¨,
k8sæ–¹å¼éƒ¨ç½²openimçš„ç›‘æ§&å‘Šè­¦ä½¿ç”¨è¯·æŸ¥é˜…é“¾æ¥æ–‡æ¡£:https://github.com/openimsdk/helm-charts/blob/main/docs/user-guide-zh.md
æºç å’Œdocker-composeéƒ¨ç½²openimçš„docker-compose.ymlæ–‡ä»¶ä¸­å„ç»„ä»¶è¯´æ˜:

| ç»„ä»¶åç§°  | ç»„ä»¶è¯´æ˜                    | å¼€å¯ç›‘æ§&å‘Šè­¦åŠŸèƒ½æ˜¯å¦å¿…é¡»                       |
|:--------:|:-----------------------:|:--------------------------------------------:|
| openim-admin| openimç®¡ç†åå°,é€šè¿‡ç®¡ç†åå°é¡µé¢è¿›å…¥ç›‘æ§é¡µé¢ | å¿…é¡» |
| prometheus| prometheusç»„ä»¶ | å¿…é¡» |
| alertmanager| å‘Šè­¦ç®¡ç†ç»„ä»¶ | å¿…é¡» |
| grafana| grafanaç»„ä»¶ | å¿…é¡» |
| node-exporter| node-exporterç»„ä»¶,ç”¨äºprometheusç»„ä»¶æ‹‰å–nodeæŒ‡æ ‡ä¿¡æ¯ | å¯é€‰ |

ç›‘æ§&å‘Šè­¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶é…ç½®è¯´æ˜:

| æ–‡ä»¶åç§°  | æ–‡ä»¶è¯´æ˜                    | ä¿®æ”¹é¡¹                       |
|:--------:|:-----------------------:|:--------------------------------------------:|
| config/config.yaml| openimæœåŠ¡çš„é…ç½®æ–‡ä»¶ | éœ€è®¾ç½®prometheus.enable: true,é»˜è®¤æ— éœ€ä¿®æ”¹ |
| config/prometheus.yml| prometheusç»„ä»¶é…ç½®æ–‡ä»¶ | é…ç½®Prometheusç»„ä»¶ä¿¡æ¯,è¯·æŸ¥é˜…Prometheusæ–‡æ¡£è¯´æ˜æŒ‰éœ€ä¿®æ”¹ï¼Œé»˜è®¤æ— éœ€ä¿®æ”¹ |
| config/instance-down-rules.yml| å‘Šè­¦è§„åˆ™æ–‡ä»¶ | é»˜è®¤é…ç½®ä¸¤æ¡è§„åˆ™(instance_down,database_insert_failure_alerts),è¯·æŸ¥é˜…Prometheusæ–‡æ¡£è¯´æ˜æŒ‰éœ€å¢åŠ  |
| config/alertmanager.yml| å‘Šè­¦ç®¡ç†é…ç½®æ–‡ä»¶ | é»˜è®¤é…ç½®äº†é‚®ä»¶å‘Šè­¦æ–¹å¼,éœ€è¦é…ç½®ä½ çš„å‘é€å’Œæ¥æ”¶é‚®ç®±ä¿¡æ¯ï¼Œå¦‚ä¸ä¿®æ”¹å°†ä¸èƒ½æ”¶åˆ°å‘Šè­¦ä¿¡æ¯ |
| config/email.tmpl| é‚®ä»¶å‘Šè­¦æ¨¡ç‰ˆ | é»˜è®¤é‚®ä»¶æ¨¡ç‰ˆæ¯”è¾ƒç®€å•ï¼Œè¯·æŒ‰éœ€é…ç½®ä½ çš„é‚®ä»¶æ¨¡ç‰ˆ |
| config/templates/prometheus-dashboard.yaml| openimè‡ªå®šä¹‰dashboard | æ— éœ€ä¿®æ”¹ |

> åœ¨æºç å’Œdocker-composeæ–¹å¼éƒ¨ç½²openimæ—¶å€™ï¼Œè¯·ç¡®è®¤ä½¿ç”¨çš„docker-compose.ymlæ–‡ä»¶ä¸­å¯¹åº”çš„ç›‘æ§&å‘Šè­¦ç»„ä»¶å¯ç”¨ï¼Œ
å¹¶ç¡®è®¤ç›¸åº”çš„é…ç½®æ–‡ä»¶æŒ‰éœ€ä¿®æ”¹å¥½ï¼Œä½“éªŒé˜¶æ®µå¯æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶.

## ç›‘æ§ä½“éªŒ
1. é€šè¿‡openimç®¡ç†åå°ç½‘é¡µçš„é“¾æ¥å…¥å£è®¿é—®,ç®¡ç†åå°ç½‘é¡µåœ°å€:http://ip:11002/

2. ç®¡ç†åå°é»˜è®¤ç”¨æˆ·åå’Œå¯†ç  (admin1:admin1),ç‚¹å‡»å¦‚å›¾é“¾æ¥ï¼Œå°†æ‰“å¼€ç›‘æ§çš„grafanaç½‘é¡µ.

![PC Web Interface](./assets/admin1.png)

3. ç‚¹å‡»å³ä¸Šè§’sign inæŒ‰é’®,ç™»å…¥grafanaä½¿ç”¨é»˜è®¤ç”¨æˆ·åå’Œå¯†ç (admin:admin).
![PC Web Interface](./assets/login.png)
![PC Web Interface](./assets/login1.png)

4. æ·»åŠ Prometheusæ•°æ®æºï¼Œå¦‚ä¸‹å›¾ï¼Œè¾“å…¥Prometheusæ•°æ®æºçš„url:http://172.28.0.1:19090  ç‚¹å‡»"Save and Test"è¿›è¡Œæ•°æ®æºä¿å­˜.
![PC Web Interface](./assets/database.png)


![PC Web Interface](./assets/database2.png)


5. å¯¼å…¥dockerç‰ˆæœ¬openimè‡ªå®šä¹‰dashboardä»ªè¡¨ç›˜.
ç‚¹å‡»ä¸‹å›¾çš„importæŒ‰é’®,è¿›å…¥ä»ªè¡¨ç›˜å¯¼å…¥é¡µé¢
![PC Web Interface](./assets/dashboard.png)


æ‹·è´ https://github.com/openimsdk/open-im-server/tree/main/config/templates/prometheus-dashboard.yaml å†…å®¹ åˆ°ä¸‹å›¾åŒºåŸŸ,æ¥ç€ç‚¹å‡»loadæŒ‰é’®
![PC Web Interface](./assets/dashboard2.png)


é€‰æ‹©ä½ çš„ Data Sourceå’Œjob ,ä½ å°†è¦æŸ¥çœ‹åˆ°è‡ªå®šä¹‰æŒ‡æ ‡ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾
![PC Web Interface](./assets/dashboard3.png)

6.å¯¼å…¥node-exportçš„å®˜ç½‘dashboardï¼Œç›´æ¥å®˜ç½‘(https://grafana.com/grafana/dashboards/  )å¯»æ‰¾ä½ æ»¡æ„çš„node-exporter dashboardè¯•å›¾ï¼Œ
ç„¶åå¯¼å…¥ï¼Œæ¯”å¦‚ 1860(Node Exporter Full)

![PC Web Interface](./assets/dashboard4.png)


ä½ å°†è¦æŸ¥çœ‹åˆ°node-exporteræŒ‡æ ‡ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾
![PC Web Interface](./assets/dashboard5.png)
> èƒ½æŸ¥çœ‹åˆ°node-exporteræŒ‡æ ‡ä¿¡æ¯ï¼Œä½ éœ€è¦åœ¨docker-compose.ymlä½¿node-exporterç»„ä»¶å¯ç”¨.


## å‘Šè­¦é…ç½®æ–‡ä»¶è¯´æ˜

1,é‚®ä»¶å‘Šè­¦æ¶æ„è¯´æ˜å›¾,Prometheusç»„ä»¶åŠ è½½å‘Šè­¦è§„åˆ™instance-down-rules.ymlæ–‡ä»¶ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„å‘Šè­¦ä¿¡æ¯å‘é€åˆ°alertmanagerç»„ä»¶ï¼Œ
alertmanagerç»„ä»¶åŠ è½½alertmanager.ymlå’Œemail.tmplæ–‡ä»¶ï¼Œé€šè¿‡é…ç½®çš„å‘Šè­¦é‚®ç®±ä¿¡æ¯å’Œé‚®ä»¶æ¨¡ç‰ˆå‘é€é‚®ä»¶
![PC Web Interface](./assets/alert2.png)

2,prometheus.yml æ–‡ä»¶è¯´æ˜,ä¸»è¦ç”¨æ¥é…ç½®å‘Šè­¦è§„åˆ™æ–‡ä»¶è·¯å¾„ï¼Œä¸»è¦ç”¨æ¥é…ç½®å‘Šè­¦è§„åˆ™æ–‡ä»¶è·¯å¾„ï¼Œå‘Šè­¦ç®¡ç†æœåŠ¡åœ°å€ï¼ŒæŠ“å–ç›‘æ§æ•°æ®ipåœ°å€ã€‚é»˜è®¤ä¸éœ€è¦ä¿®æ”¹ã€‚
```

# Alertmanager configuration
alerting:
alertmanagers:
- static_configs:
- targets: ['172.28.0.1:19093']

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - "instance-down-rules.yml"

```
3ï¼Œå‘Šè­¦è§„åˆ™instance-down-rules.yamlæ–‡ä»¶è¯´æ˜ï¼Œé»˜è®¤å®ç°äº†ä¸¤æ¡(instance_down,database_insert_failure_alerts)é‚®ä»¶å‘Šè­¦è§„åˆ™,
å¦‚æœå¢åŠ å‘Šè­¦è§„åˆ™å¯ä»¥åœ¨instance-down-rules.ymlæ–‡ä»¶ä¸­æ·»åŠ è§„åˆ™:
```
groups:
  - name: instance_down  #æŠ¥è­¦è§„åˆ™ä¸€:ç›‘æ§æ¨¡å—å®•æœºè¶…è¿‡ä¸€åˆ†é’Ÿå°±è§¦å‘å‘Šè­¦
    rules:
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ $labels.instance }} down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minutes."

  - name: database_insert_failure_alerts #æŠ¥è­¦è§„åˆ™äºŒ:ç›‘æ§æŒ‡æ ‡msg_insert_redis_failed_totalå’Œmsg_insert_mongo_failed_totalæœ‰å¢é•¿å°±è§¦å‘æŠ¥è­¦
    rules:
      - alert: DatabaseInsertFailed
        expr: (increase(msg_insert_redis_failed_total[5m]) > 0) or (increase(msg_insert_mongo_failed_total[5m]) > 0)
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Increase in MsgInsertRedisFailedCounter or MsgInsertMongoFailedCounter detected"
          description: "Either MsgInsertRedisFailedCounter or MsgInsertMongoFailedCounter has increased in the last 5 minutes, indicating failures in message insert operations to Redis or MongoDB,maybe the redis or mongodb is crash."
```

4ï¼Œå‘Šè­¦ç®¡ç†alertmanager.ymlæ–‡ä»¶è¯´æ˜,è¯·ä¿®æ”¹æˆä½ çœŸå®çš„å‘é€é‚®ç®±å’Œæ¥æ”¶é‚®ç®±é…ç½®ä¿¡æ¯ï¼Œå³å¯æ¥æ”¶å‘Šè­¦ä¿¡æ¯,
å¦‚æœæƒ³å®ç°é’‰é’‰ï¼Œä¼ä¸šå¾®ä¿¡ç­‰æ–¹å¼çš„å‘Šè­¦é€šçŸ¥ï¼Œéœ€è¦è‡ªè¡Œæ”¹å†™alertmanager.ymlï¼Œ
å¯ä»¥å‚é˜…å‘Šè­¦ç®¡ç†æ¨¡å—å®˜æ–¹æ–‡æ¡£ï¼šhttps://prometheus.io/docs/alerting/latest/alertmanager/
```
global:
  resolve_timeout: 5m
  smtp_from: alert@openim.io #å‘Šè­¦ä¿¡æ¯å‘é€é‚®ç®±
  smtp_smarthost: smtp.163.com:465 #å‘é€é‚®ç®±smtpåœ°å€
  smtp_auth_username: alert@openim.io #å‘é€é‚®ç®±æˆæƒç”¨æˆ·åï¼Œä¸€èˆ¬å’Œæ¸¸æˆåœ°å€ç›¸åŒ
  smtp_auth_password: YOURAUTHPASSWORD #å‘é€é‚®ç®±æˆæƒç 
  smtp_require_tls: false
  smtp_hello: openim alert

templates:
  - /etc/alertmanager/email.tmpl #é‚®ä»¶æ¨¡ç‰ˆ

route:
  group_by: ['alertname']
  group_wait: 5s
  group_interval: 5s
  repeat_interval: 5m
  receiver: email
receivers:
  - name: email
    email_configs:
      - to: 'alert@example.com' #æ¥æ”¶å‘Šè­¦é‚®ç®±
        html: '{{ template "email.to.html" . }}'
        headers: { Subject: "[OPENIM-SERVER]Alarm" }#é‚®ä»¶æ ‡é¢˜
        send_resolved: true
```
5ï¼Œé‚®ä»¶æ¨¡ç‰ˆæ–‡ä»¶email.tmplè¯´æ˜ï¼Œæ­¤æ–‡ä»¶æ˜¯htmlæ ¼å¼ï¼Œå‘Šè­¦ç®¡ç†æ¨¡å—ä¼šå¡«å……é‡Œé¢çš„å˜é‡ä¿¡æ¯ï¼Œç„¶åæ¸²æŸ“æˆhtmlæ ¼å¼æ–‡ä»¶ï¼Œè¿›è¡Œé‚®ä»¶çš„å‘é€ï¼Œ
ä½ å¯ä»¥è·Ÿç€è‡ªå·±çš„éœ€è¦è¿›è¡Œæ¨¡ç‰ˆæ–‡ä»¶çš„æ”¹å†™:
```
{{ define "email.to.html" }}
{{ range .Alerts }}
<!-- Begin of OpenIM Alert -->
<div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
    <h3>OpenIM Alert</h3>
    <p><strong>Alert Program:</strong> Prometheus Alert</p>
    <p><strong>Severity Level:</strong> {{ .Labels.severity }}</p>
    <p><strong>Alert Type:</strong> {{ .Labels.alertname }}</p>
    <p><strong>Affected Host:</strong> {{ .Labels.instance }}</p>
    <p><strong>Affected Service:</strong> {{ .Labels.job }}</p>
    <p><strong>Alert Subject:</strong> {{ .Annotations.summary }}</p>
    <p><strong>Trigger Time:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
</div>
<!-- End of OpenIM Alert -->
{{ end }}
{{ end }}
```


## å‘Šè­¦ä½“éªŒ
å¯æ‰‹åŠ¨è§¦å‘instancedownå‘Šè­¦è§„åˆ™ï¼Œå¦‚æœæ˜¯æºç éƒ¨ç½²openimæ–¹å¼ï¼Œæ‰§è¡Œ `make stop`å‘½ä»¤åœæ­¢openim-serveræœåŠ¡ï¼Œç­‰å¾…5måˆ†é’Ÿä»¥ä¸Šï¼Œå³å¯æ”¶åˆ°å‘Šè­¦é‚®ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

![PC Web Interface](./assets/alert6.png)

# æ—¥å¿—ç³»ç»Ÿ
å¦‚æœæ˜¯åœ¨k8sç¯å¢ƒé€šè¿‡helm chartæ–¹å¼éƒ¨ç½²çš„openimæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡grafanaæŸ¥çœ‹lokiæ—¥å¿—ï¼Œå³é€šè¿‡grafanaæŸ¥çœ‹openimæ‰€æœ‰æœåŠ¡çš„æ—¥å¿—ä¿¡æ¯ã€‚
ç›®å‰äºŒè¿›åˆ¶å’Œdockeréƒ¨ç½²æ²¡æœ‰é›†æˆlokiæ—¥å¿—æ”¶é›†ç»„ä»¶ï¼Œæƒ³ä½“éªŒlokiæ—¥å¿—æ”¶é›†åŠŸèƒ½ï¼Œè¯·é‡‡ç”¨helm chartéƒ¨ç½²ï¼Œ
è¯¦æƒ…è¯·æŸ¥é˜…é“¾æ¥https://github.com/openimsdk/helm-charts/blob/main/docs/user-guide-zh.md