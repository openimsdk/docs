1. 

   ## é›†ç¾¤éƒ¨ç½²è¯´æ˜

   `open-im-server`æ”¯æŒé›†ç¾¤éƒ¨ç½²ã€‚ä»¥ä¸‹æ˜¯**æºç é›†ç¾¤**éƒ¨ç½²çš„æ­¥éª¤ï¼š

   åœºæ™¯ï¼šä¸¤å°æœºå™¨éƒ¨ç½²`open-im-server`ï¼Œåˆ†åˆ«ä¸ºæœºå™¨Aå’Œæœºå™¨Bï¼Œå‡è®¾ä¸¤å°æœºå™¨åœ¨åŒä¸€å†…ç½‘ä¸­ã€‚

   æœºå™¨Aï¼šéƒ¨ç½²`open-im-server`ã€`nginx`ã€`mongo`ã€`redis`ã€`etcd`ã€`kafka`ã€`minio`ã€`prometheus`ã€`grafana`ã€`aleartmanager`ã€‚

   æœºå™¨Bï¼šéƒ¨ç½²`open-im-server`ã€‚

   ç»„ä»¶`mongo`ã€`redis`ã€`kafka`ã€`etcd`å‡æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œä»¥ä¸‹åœºæ™¯é»˜è®¤æ¯ä¸ªç»„ä»¶é›†ç¾¤éƒ¨ç½²3å°ã€‚

   1. æœºå™¨Aã€Bï¼šå…‹éš†ä»“åº“ï¼š

      ```bash
      git clone https://github.com/openimsdk/open-im-server && cd open-im-server
      ```

   2. æœºå™¨Aï¼šä¿®æ”¹`kafka`ã€`minio`ã€`mongodb`ã€`etcd`ï¼ˆé»˜è®¤æœåŠ¡å‘ç°æ–¹å¼ï¼‰ã€`redis`ä¸­çš„åœ°å€ï¼Œå°†å…¶é…ç½®åˆ°æ­£ç¡®çš„ç»„ä»¶åœ°å€ä¸­ã€‚**ä¿è¯è¿æ¥ç»„ä»¶çš„å„ä¸ªç«¯å£å¯è®¿é—®ï¼ˆå…³æ³¨é˜²ç«å¢™è§„åˆ™æ˜¯å¦å…è®¸ç«¯å£è¢«è®¿é—®ï¼‰ã€‚**
      ä¿®æ”¹`open-im-server/config`ç›®å½•ä¸‹ï¼Œå¯¹åº”ç»„ä»¶çš„åœ°å€ã€‚
      å¯¹åº”é…ç½®æ–‡ä»¶å­—æ®µä¸ºï¼š

      - `kafka`: `kafka.yml:address`ï¼Œå†…å®¹ä¸º`[ kafkaAddr1, kafkaAddr2, kafkaAddr3 ]`
      - `minio`: `minio.yml`ï¼Œ`internalAddress`é…ç½®å†…éƒ¨æœåŠ¡è®¿é—®åœ°å€ï¼Œ`externalAddress`é…ç½®å¤–éƒ¨è®¿é—®`minio`çš„åœ°å€ã€‚
      - `mongo`ï¼š`mongodb.yml:address`ï¼Œå†…å®¹ä¸º`[ mongoAddr1, mongoAddr2, mongoAddr3 ]`
      - `etcd`: `discovery.yml:etcd.address`ï¼Œå†…å®¹ä¸º`[ etcdAddr1, etcdAddr2, etcdAddr3 ]`
      - `redis`: `redis.yml:address`ï¼Œå†…å®¹ä¸º`[ redis1, redis2, redis3 ]`ï¼Œå¹¶å°†`redis.yml`ä¸­çš„`clusterMode`è®¾ç½®ä¸º`true`ï¼ˆå•æœºéƒ¨ç½²ä¸éœ€è¦ï¼‰ã€‚

   3. åœ¨`open-im-server/start-config.yml`ä¸­æ ¹æ®éœ€æ±‚ä¿®æ”¹å„ä¸ªç»„ä»¶æ•°é‡ã€‚
   
   4. æœºå™¨Aéƒ¨ç½²`nginx`ï¼Œå‚è€ƒé…ç½®å¦‚ä¸‹ï¼š
   
      >ğŸš€ **æç¤º**: ç¡®ä¿æ›¿æ¢æˆæ‚¨çš„å®é™…åŸŸåã€SSL è¯ä¹¦è·¯å¾„å’Œ SSL å¯†é’¥ã€‚
   
      ```yaml
      events {
          worker_connections 1024;
      }
      
      http {
          #open-im-server chat Corresponding deployment address and port
          upstream msg_gateway{
              #IM Message server address Multiple can be specified according to the deployment
              server 127.0.0.1:10001;
              server 192.168.2.36:10001;
          }
          upstream im_api{
              #IM Group user api server address Multiple can be specified according to the deployment
              server 127.0.0.1:10002;
              server 192.168.2.36:10001;
          }
          upstream minio_s3_2{
              #Minio address can be assigned to multiple modules dependingon deployment
              server 127.0.0.1:10005;
          }
          server {
              listen       443; #Listening on port 443
              server_name  web.xx.xx;  #Your domain name
              ssl on;
              #Path of pem file for ssl certificate
              ssl_certificate /usr/local/nginx/conf/ssh/web.xx.xx_bundle.pem;
              #Key file path of ssl certificate
              ssl_certificate_key /usr/local/nginx/conf/ssh/web.xx.xx.key;
      
              gzip on;
              gzip_min_length 1k;
              gzip_buffers 4 16k;
              gzip_comp_level 2;
              gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/wasm;
              gzip_vary off;
              gzip_disable "MSIE [1-6]\.";
      
              location ^~/api/{
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "Upgrade";
                  proxy_set_header X-real-ip $remote_addr;
                  proxy_set_header X-Forwarded-For $remote_addr;
                  proxy_set_header X-Request-Api $scheme://$host/api;
                  proxy_pass http://im_api/;
              }
      
              location /msg_gateway{
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "Upgrade";
                  proxy_set_header X-real-ip $remote_addr;
                  proxy_set_header X-Forwarded-For $remote_addr;
                  proxy_pass http://msg_gateway/;
              }
      
              location ^~/im-minio-api/ {
                  proxy_set_header Host $http_host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_connect_timeout 300;
      
                  proxy_http_version 1.1;
                  proxy_set_header Connection "";
                  chunked_transfer_encoding off;
                  proxy_pass http://minio_s3_2/;
              }
          }
      }
      ```
   
   5. `mage`ç¼–è¯‘ï¼Œ`mage start`å¯åŠ¨æœåŠ¡ã€‚
   
   ## **å¸¸è§é—®é¢˜/æ³¨æ„äº‹é¡¹**
   
   1. éƒ¨ç½²`kafka`æ—¶ï¼Œéœ€è¦ä¿®æ”¹`kafka`å¹¿æ’­çš„ç«¯å£ã€‚å¦‚æœä½¿ç”¨`open-im-server`ä¸­çš„`docker-compose.yml`éƒ¨ç½²ï¼Œä¿®æ”¹`service.kafka.environment.KAFKA_CFG_ADVERTISED_LISTENERS`ä¸­çš„`EXTERNAL`ä¸ºè®¿é—®`kafka`ç»„ä»¶çš„åœ°å€ã€‚å…¶ä»–éƒ¨ç½²æ–¹å¼è¯·è‡ªè¡Œä¿®æ”¹ã€‚
      ä¾‹å¦‚ï¼š`KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://192.168.2.36:19094`ã€‚
   2. å¤šå°æœºå™¨éƒ¨ç½²éœ€è¦ä¿è¯æ—¶é’Ÿä¸€è‡´ï¼ŒæœåŠ¡æ‰å¯æ­£å¸¸è¿è¡Œã€‚ä¾‹å¦‚`token`çš„ç­¾å‘å…è®¸å„ä¸ªæœºå™¨çš„æ—¶é’Ÿè¯¯å·®åœ¨`5s`ä»¥å†…ã€‚
   3. ç»„ä»¶ç«¯å£æ— æ³•è®¿é—®ï¼šé€šè¿‡å›ç¯åœ°å€æ£€æµ‹ç»„ä»¶å¯åŠ¨æ˜¯å¦æ­£å¸¸ï¼Œè‹¥å›ç¯åœ°å€å¯è®¿é—®ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦è¢«é˜²ç«å¢™è§„åˆ™è¿‡æ»¤ã€‚
   4. å¦‚æœé›†ç¾¤æœºå™¨**ä¸åœ¨å†…ç½‘ä¸­**ï¼Œéœ€è¦å°†`autoSetPorts`è®¾ç½®ä¸º`false`ï¼Œå¹¶ä¿®æ”¹å„ä¸ª`rpc`ç»„ä»¶çš„`registerIP`ä¸ºè®¾ç½®éƒ¨ç½²`etcd`çš„æœåŠ¡å™¨å¯è®¿é—®çš„`ip`åœ°å€ï¼Œ**å¹¶ä¿è¯å„ä¸ªç«¯å£å¯è¢«è®¿é—®**ã€‚å¦‚éœ€å¯ç”¨`prometheus`ï¼Œè¿˜éœ€è¦ä¿è¯å„ä¸ªç»„ä»¶çš„`prometheus.port`ç«¯å£å¯è¢«è®¿é—®ã€‚
      æ‹¥æœ‰`autoSetPorts`é…ç½®çš„ç»„ä»¶å¦‚ä¸‹ï¼š

      - `openim-api.yml:prometheus.autoSetPorts`
      - `openim-msggateway.yml:rpc.autoSetPorts`
      - `openim-msgtransfer.yml:prometheus.autoSetPorts`
      - `openim-push.yml:rpc.autoSetPorts`
      - `openim-rpc-auth.yml:rpc.autoSetPorts`
      - `openim-rpc-conversation.yml:rpc.autoSetPorts`
      - `openim-rpc-friend.yml:rpc.autoSetPorts`
      - `openim-rpc-group.yml:rpc.autoSetPorts`
      - `openim-rpc-msg.yml:rpc.autoSetPorts`
      - `openim-rpc-third.yml:rpc.autoSetPorts`
      - `openim-rpc-user.yml:rpc.autoSetPorts`
   
      ![rpc0](./cluster.assets/rpc0.png)
   
      æ­¤å¤–ï¼Œæœºå™¨Aè¿˜éœ€è¦ä¿®æ”¹`prometheus.yml`ï¼Œå°†å…¶ä¸­çš„æ‰€æœ‰`http_sd_configs`é…ç½®é¡¹åŠå…¶å­é…ç½®é¡¹å»æ‰ï¼ŒåŠ ä¸Š`static_configs`é…ç½®é¡¹ï¼Œå¹¶å°†å…¶ä¸­çš„`targets`æ”¹ä¸ºå¯¹åº”çš„æœåŠ¡çš„ç«¯å£ã€‚
      ä¾‹å¦‚ï¼š`openimserver-openim-api`è¡¨ç¤º`api`ç»„ä»¶çš„`prometheus`æ•°æ®æŠ“å–ï¼Œåˆ™å…¶`target`ä¸­çš„ç«¯å£åœ°å€åº”å’Œ`openim-api.yml`ä¸­çš„`prometheus.ports`ä¸€è‡´ã€‚
   
      ![prometheus0](./cluster.assets/prometheus0.png)
