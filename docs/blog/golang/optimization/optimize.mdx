---
title: 消息传输优化策略文档
hide_title: true
sidebar_position: 3
---

# OpenIM 消息传输优化策略文档

## 引言

随着即时通讯应用的广泛使用，消息传输的效率和稳定性成为系统性能优化的关键因素。本文针对`OpenIM`在消息从客户端发送至服务端接收，再由服务端推送至其他客户端的整个过程中存在的性能瓶颈，提出了一系列优化策略。这些策略涵盖了`RPC`调用优化、消息处理耗时减少、推送机制改进、客户端性能优化、数据库操作优化以及日志管理优化等多个方面，旨在提升系统的整体性能和用户体验。

## 1. RPC 压力分析与优化

### 1.1 压力分析

利用`Prometheus`监控工具和`top`命令，分析各RPC接口的压力情况，识别出压力较大的RPC调用。

### 1.2 增加RPC数量

针对压力较大的RPC接口，适当增加RPC实例数量，以分摊负载，提升处理能力，避免单点瓶颈。

## 2. 消息耗时来源分析

通过监控和日志分析，确定消息发送耗时主要集中在服务端还是客户端：

- **服务端**：说明存在消息积压现象，消息处理速度较慢。
- **客户端**：说明处理消息耗时较长，需进一步优化。

## 3 服务端优化策略

### 3.1 识别耗时步骤

通过`Prometheus`以及日志分析，发现推送消息需要查询用户的在线状态，而首次查询用户在线状态时如果未命中缓存，会调用RPC接口查询。而本地缓存缺少批量存储接口，导致更新缓存时会循环多次调用RPC接口。这种情况在推送大群中的消息时比较容易出现。

### 3.2 缓存策略优化

原有的缓存方案为，每查询一个用户，就保存其在线状态，无论是否在线。采用Redis发布订阅机制来维护缓存。

目前有两种优化方案：

1. **全量在线用户缓存**：
   - 改变缓存策略，维护所有在线用户的缓存，启动时缓存预热。只要用户不在缓存中即判断用户不在线。
   - 适用于内存充足的场景，避免请求在线状态时的RPC调用，显著提高效率。
2. **批量缓存插入**：
   - 保持原有缓存方案，改为批量插入本地缓存，替代循环单次插入。批量查询在线状态能够减少RPC调用次数，提升效率。

### 3.3 推送机制优化

#### 3.3.1 在线与离线推送分析

日志分析显示，在优化获取用户在线状态后，在线推送和离线推送各占推送总耗时的约一半。

#### 3.3.2 异步离线推送

- **异步处理**：相对在线推送，离线推送的实时性要求较低。因此将离线推送改为异步方式，避免阻塞主流程。
- **数据持久化**：利用Kafka确保数据不丢失，提高系统的可靠性和推送效率。

## 4. 客户端优化

### 4.1 阻塞超时问题分析

- 在群成员变动数量较多的情况下，通知消息体积过大，导致处理时间过长，阻塞后续消息。
- 通过添加详细日志，逐步分析客户端各步骤的耗时，发现在高压环境下存在激烈的锁竞争问题，`SQLite`数据库可能由于压力过大出现“database is locked”错误

### 4.2 优化策略

#### 4.2.1 消息体积过大优化

- **限制API参数长度**：将API请求的参数进行分片处理，减小每次请求的数据量。
- **分片请求**：分片发送API请求，降低客户端接收通知数据的大小，提高处理效率。

#### 4.2.2 锁竞争优化

- **细化锁粒度**：将锁的粒度细化，移除业务逻辑中不必要的同步锁，细化为数据库操作的锁，减少锁竞争，提高并发处理能力，又能确保数据库操作的串行化。
- **本地缓存引入**：添加本地缓存，减少对共享资源的访问，降低锁竞争的可能性。

## 5. 日志管理优化

### 5.1 降低日志级别

通过调整日志级别，减少日志输出量，从而提升系统运行效率。

### 5.2 日志记录策略

- **关键节点记录**：确保在每个重要的流程节点记录INFO级别日志，便于追踪流程链路。
- **平衡日志量**：控制日志输出量，生产环境一般使用INFO级别日志，确保将不重要的日志或者开调试时才有价值的日志定为DEBUG级别，既保证问题追踪的需求，又不影响系统性能。

## 6. 测试环境优化

### 6.1 压力测试优化

在进行服务器模拟多客户端测试时，客户端提供的压力较大，而需要测试的为服务端的压力，客户端压力会影响测试结果的准确性。

### 6.2 优化措施

- **高性能机器选择**：选用性能优越的服务器，确保测试环境能够承受高负载。
- **使用Unix共享内存**：在客户端较多时，采用Unix的共享内存机制，减少大量磁盘IO操作，提高测试效率和准确性。

## 结论

通过对OpenIM消息传输过程中各环节的详细分析与优化，本文提出了一系列切实可行的优化策略。这些策略涵盖了从服务端到客户端的全流程优化，旨在提升系统的整体性能、稳定性和用户体验。未来，随着系统规模的扩大和业务需求的增长，需持续监控系统性能，动态调整优化策略，确保OpenIM能够高效稳定地运行。