---
title: 'æºç é›†ç¾¤éƒ¨ç½²æŒ‡å—'
sidebar_position: 6
---




## open-im-server æºç é›†ç¾¤éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—å°†æŒ‡å¯¼æ‚¨åœ¨ä¸¤å°æœºå™¨ï¼ˆA å’Œ Bï¼Œå†…ç½‘ IP åˆ†åˆ«ä¸º `IP_A` å’Œ `IP_B`ï¼‰ä¸Šé›†ç¾¤éƒ¨ç½² `open-im-server` å’Œ `nginx`ï¼Œå¹¶åœ¨æœºå™¨ A ä¸Šéƒ¨ç½²ç›‘æ§ç»„ä»¶ï¼ˆPrometheusã€Grafanaã€Alertmanagerï¼‰ã€‚
å‡è®¾æ‚¨å·²éƒ¨ç½² Redis é›†ç¾¤ã€MongoDB åˆ†ç‰‡é›†ç¾¤ã€Kafka é›†ç¾¤åŠ Etcd é›†ç¾¤ï¼Œå…·ä½“åœ°å€å¦‚ä¸‹ï¼š

- **Redis é›†ç¾¤åœ°å€**: `redisAddr1`, `redisAddr2`, `redisAddr3`
- **MongoDB é›†ç¾¤åœ°å€**: `mongoAddr1`, `mongoAddr2`, `mongoAddr3`
- **Kafka é›†ç¾¤åœ°å€**: `kafkaAddr1`, `kafkaAddr2`, `kafkaAddr3`
- **Etcd é›†ç¾¤åœ°å€**: `etcdAddr1`, `etcdAddr2`, `etcdAddr3`

æ­¤å¤–ï¼ŒMinIO çš„å†…éƒ¨æœåŠ¡è®¿é—®åœ°å€é…ç½®ä¸º `internalAddress`ï¼Œå¤–éƒ¨è®¿é—®åœ°å€é…ç½®ä¸º `externalAddress`ã€‚
A å’Œ B ä¸¤å°æœºå™¨å†…ç½‘äº’é€šï¼Œä¸”Aã€Bä¸¤å°æœºå™¨éƒ½æœ‰å¤–ç½‘IPã€‚

### ç›®å½•ç»“æ„

1. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
2. [å…‹éš†ä»“åº“](#1-å…‹éš†ä»“åº“)
3. [é…ç½®ä¿®æ”¹](#2-é…ç½®ä¿®æ”¹)
4. [é…ç½® nginx](#3-é…ç½®-nginx)
5. [è®¾ç½® DNS](#4-è®¾ç½®-dns)
6. [å¯åŠ¨æœåŠ¡](#5-å¯åŠ¨æœåŠ¡)
7. [ä¿®æ”¹å®¢æˆ·ç«¯ SDK åˆå§‹åŒ–å‚æ•°](#6-ä¿®æ”¹å®¢æˆ·ç«¯-sdk-åˆå§‹åŒ–å‚æ•°)

### å‰ææ¡ä»¶

ç¡®ä¿ä»¥ä¸‹ç»„ä»¶å·²æ­£ç¡®éƒ¨ç½²å¹¶è¿è¡Œï¼š

- **Redis é›†ç¾¤**
- **MongoDB åˆ†ç‰‡é›†ç¾¤**
- **Kafka é›†ç¾¤**
- **Etcd é›†ç¾¤**
- **MinIO æœåŠ¡**

### 1. å…‹éš†ä»“åº“

åœ¨ä¸¤å°æœºå™¨ï¼ˆA å’Œ Bï¼‰ä¸Šåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å…‹éš† `open-im-server` ä»“åº“ï¼š

```bash
git clone https://github.com/openimsdk/open-im-server
cd open-im-server
```

### 2. é…ç½®ä¿®æ”¹

åœ¨æœºå™¨ A å’Œ B ä¸Šï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç¡®ä¿å„ç»„ä»¶æ­£ç¡®è¿æ¥ã€‚æ‰€æœ‰åœ°å€å­—æ®µå‡é‡‡ç”¨å•è¡Œåˆ—è¡¨æ ¼å¼ `address: [addr1, addr2, addr3]`ã€‚

#### 2.1 Kafka é…ç½®

ç¼–è¾‘ `open-im-server/config/kafka.yml` æ–‡ä»¶ï¼Œè®¾ç½® `address` å­—æ®µä¸º Kafka é›†ç¾¤åœ°å€åˆ—è¡¨ï¼š

```yaml
address: [kafkaAddr1, kafkaAddr2, kafkaAddr3]
```

#### 2.2 MinIO é…ç½®

ç¼–è¾‘ `open-im-server/config/minio.yml` æ–‡ä»¶ï¼Œè®¾ç½® `internalAddress` å’Œ `externalAddress`ï¼š

```yaml
internalAddress: your_minio_internal_address
externalAddress: your_minio_external_address
```

#### 2.3 MongoDB é…ç½®

ç¼–è¾‘ `open-im-server/config/mongodb.yml` æ–‡ä»¶ï¼Œè®¾ç½® `address` å­—æ®µä¸º MongoDB é›†ç¾¤åœ°å€åˆ—è¡¨ï¼š

```yaml
address: [mongoAddr1, mongoAddr2, mongoAddr3]
```

#### 2.4 Etcd é…ç½®

ç¼–è¾‘ `open-im-server/config/discovery.yml` æ–‡ä»¶ï¼Œè®¾ç½® `etcd.address` å­—æ®µä¸º Etcd é›†ç¾¤åœ°å€åˆ—è¡¨ï¼š

```yaml
etcd:
  address: [etcdAddr1, etcdAddr2, etcdAddr3]
```

#### 2.5 Redis é…ç½®

ç¼–è¾‘ `open-im-server/config/redis.yml` æ–‡ä»¶ï¼Œè®¾ç½® `address` å­—æ®µä¸º Redis é›†ç¾¤åœ°å€åˆ—è¡¨ï¼Œå¹¶å¯ç”¨é›†ç¾¤æ¨¡å¼ï¼š

```yaml
address: [redisAddr1, redisAddr2, redisAddr3]
clusterMode: true
```

### 3. é…ç½® nginx

åœ¨æœºå™¨ A ã€Bä¸Šéƒ¨ç½² `nginx`ï¼Œå‚è€ƒä»¥ä¸‹é…ç½®ã€‚è¯·ç¡®ä¿æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸåã€SSL è¯ä¹¦è·¯å¾„å’Œ SSL å¯†é’¥è·¯å¾„ã€‚

> ğŸš€ **æç¤º**: ç¡®ä¿æ›¿æ¢æˆæ‚¨çš„å®é™…åŸŸåã€SSL è¯ä¹¦è·¯å¾„å’Œ SSL å¯†é’¥ã€‚

```nginx
events {
    worker_connections 1024;
}

http {
    # open-im-server 
    upstream msg_gateway {
        server IP_A:10001;
        server IP_B:10001;
    }

    upstream im_api {
        # IM API æœåŠ¡å™¨åœ°å€ï¼Œå¯æ ¹æ®éƒ¨ç½²æƒ…å†µæŒ‡å®šå¤šä¸ª
        server IP_A:10002;
        server IP_B:10002;
    }

    server {
        listen       443 ssl;
        server_name  your_domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå

        ssl_certificate     /usr/local/nginx/conf/ssl/your_domain_bundle.pem;  # æ›¿æ¢ä¸ºæ‚¨çš„è¯ä¹¦è·¯å¾„
        ssl_certificate_key /usr/local/nginx/conf/ssl/your_domain.key;        # æ›¿æ¢ä¸ºæ‚¨çš„è¯ä¹¦å¯†é’¥è·¯å¾„

        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_comp_level 2;
        gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/wasm;
        gzip_vary off;
        gzip_disable "MSIE [1-6]\.";

        location ^~/api/ {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Request-Api $scheme://$host/api;
            proxy_pass http://im_api/;
        }

        location /msg_gateway/ {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_pass http://msg_gateway/;
        }
    }

    # å¯é€‰: HTTP é‡å®šå‘åˆ° HTTPS
    server {
        listen 80;
        server_name your_domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå

        return 301 https://$host$request_uri;
    }
}
```

å°†æ­¤é…ç½®æ·»åŠ åˆ° `nginx` çš„é…ç½®æ–‡ä»¶ä¸­ï¼ˆä¾‹å¦‚ `/usr/local/nginx/conf/nginx.conf`ï¼‰ï¼Œå¹¶é‡å¯ `nginx` æœåŠ¡ï¼š

```bash
sudo nginx -t  
sudo systemctl restart nginx  
```

### 4. è®¾ç½® DNS

å°†æ‚¨çš„åŸŸå `your_domain.com` æŒ‡å‘æœºå™¨A Bçš„å¤–ç½‘ IP åœ°å€ã€‚

### 5. å¯åŠ¨æœåŠ¡

åœ¨ä¸¤å°æœºå™¨ï¼ˆA å’Œ Bï¼‰çš„ `open-im-server` ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥ç¼–è¯‘å’Œå¯åŠ¨æœåŠ¡ï¼š

#### 5.1 ç¼–è¯‘

```bash
mage
```

#### 5.2 å¯åŠ¨æœåŠ¡

```bash
mage start
```


### 6. ä¿®æ”¹å®¢æˆ·ç«¯ SDK åˆå§‹åŒ–å‚æ•°

åœ¨å®¢æˆ·ç«¯ SDK ä¸­ï¼Œé…ç½®åˆå§‹åŒ–å‚æ•°å¦‚ä¸‹ï¼š

- `apiAddr`: `https://your_domain.com/api`
- `wsAddr`: `https://your_domain.com/msg_gateway`






## **å¸¸è§é—®é¢˜/æ³¨æ„äº‹é¡¹**

1. éƒ¨ç½²`kafka`æ—¶ï¼Œéœ€è¦ä¿®æ”¹`kafka`å¹¿æ’­çš„ç«¯å£ã€‚å¦‚æœä½¿ç”¨`open-im-server`ä¸­çš„`docker-compose.yml`éƒ¨ç½²ï¼Œä¿®æ”¹`service.kafka.environment.KAFKA_CFG_ADVERTISED_LISTENERS`ä¸­çš„`EXTERNAL`ä¸ºè®¿é—®`kafka`ç»„ä»¶çš„åœ°å€ã€‚å…¶ä»–éƒ¨ç½²æ–¹å¼è¯·è‡ªè¡Œä¿®æ”¹ã€‚
   ä¾‹å¦‚ï¼š`KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://192.168.2.36:19094`ã€‚
2. å¤šå°æœºå™¨éƒ¨ç½²éœ€è¦ä¿è¯æ—¶é’Ÿä¸€è‡´ï¼ŒæœåŠ¡æ‰å¯æ­£å¸¸è¿è¡Œã€‚ä¾‹å¦‚`token`çš„ç­¾å‘å…è®¸å„ä¸ªæœºå™¨çš„æ—¶é’Ÿè¯¯å·®åœ¨`5s`ä»¥å†…ã€‚
3. ç»„ä»¶ç«¯å£æ— æ³•è®¿é—®ï¼šé€šè¿‡å›ç¯åœ°å€æ£€æµ‹ç»„ä»¶å¯åŠ¨æ˜¯å¦æ­£å¸¸ï¼Œè‹¥å›ç¯åœ°å€å¯è®¿é—®ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦è¢«é˜²ç«å¢™è§„åˆ™è¿‡æ»¤ã€‚
4. å¦‚æœé›†ç¾¤æœºå™¨**ä¸åœ¨å†…ç½‘ä¸­**ï¼Œéœ€è¦å°†`autoSetPorts`è®¾ç½®ä¸º`false`ï¼Œå¹¶ä¿®æ”¹å„ä¸ª`rpc`ç»„ä»¶çš„`registerIP`ä¸ºè®¾ç½®éƒ¨ç½²`etcd`çš„æœåŠ¡å™¨å¯è®¿é—®çš„`ip`åœ°å€ï¼Œ**å¹¶ä¿è¯å„ä¸ªç«¯å£å¯è¢«è®¿é—®**ã€‚å¦‚éœ€å¯ç”¨`prometheus`ï¼Œè¿˜éœ€è¦ä¿è¯å„ä¸ªç»„ä»¶çš„`prometheus.port`ç«¯å£å¯è¢«è®¿é—®ã€‚
   æ‹¥æœ‰`autoSetPorts`é…ç½®çš„ç»„ä»¶å¦‚ä¸‹ï¼š

   - `openim-api.yml:prometheus.autoSetPorts`
   - `openim-msggateway.yml:rpc.autoSetPorts`
   - `openim-msgtransfer.yml:prometheus.autoSetPorts`
   - `openim-push.yml:rpc.autoSetPorts`
   - `openim-rpc-auth.yml:rpc.autoSetPorts`
   - `openim-rpc-conversation.yml:rpc.autoSetPorts`
   - `openim-rpc-friend.yml:rpc.autoSetPorts`
   - `openim-rpc-group.yml:rpc.autoSetPorts`
   - `openim-rpc-msg.yml:rpc.autoSetPorts`
   - `openim-rpc-third.yml:rpc.autoSetPorts`
   - `openim-rpc-user.yml:rpc.autoSetPorts`

   ![rpc0](./cluster.assets/rpc0.png)

   æ­¤å¤–ï¼Œæœºå™¨Aè¿˜éœ€è¦ä¿®æ”¹`prometheus.yml`ï¼Œå°†å…¶ä¸­çš„æ‰€æœ‰`http_sd_configs`é…ç½®é¡¹åŠå…¶å­é…ç½®é¡¹å»æ‰ï¼ŒåŠ ä¸Š`static_configs`é…ç½®é¡¹ï¼Œå¹¶å°†å…¶ä¸­çš„`targets`æ”¹ä¸ºå¯¹åº”çš„æœåŠ¡çš„ç«¯å£ã€‚
   ä¾‹å¦‚ï¼š`openimserver-openim-api`è¡¨ç¤º`api`ç»„ä»¶çš„`prometheus`æ•°æ®æŠ“å–ï¼Œåˆ™å…¶`target`ä¸­çš„ç«¯å£åœ°å€åº”å’Œ`openim-api.yml`ä¸­çš„`prometheus.ports`ä¸€è‡´ã€‚

   ![prometheus0](./cluster.assets/prometheus0.png)
